id: incident-enricher.enrich
name: Incident Enricher
version: "0.1.0"
input_schema:
  $schema: "http://json-schema.org/draft-07/schema#"
  type: object
  required: [incident_id, source, destination]
  properties:
    incident_id:
      type: string
      minLength: 1
    title:
      type: string
    severity:
      type: string
      enum: [low, medium, high, critical]
    source:
      type: object
      required: [system]
      properties:
        system:
          type: string
          enum: [mock, pagerduty]
        url:
          type: string
      additionalProperties: true
    raw:
      type: object
      additionalProperties: true
    destination:
      type: object
      required: [mode]
      properties:
        mode:
          type: string
          enum: [artifact, slack]
        slack_webhook_url:
          type: string
      additionalProperties: true
  additionalProperties: false

steps:
  fetch:
    type: worker
    topic: job.incident-enricher.fetch
    meta:
      pack_id: incident-enricher
      capability: incident.fetch
      risk_tags: ["network"]
      requires: ["network:egress"]
    output_schema_id: incident-enricher/EvidenceBundle

  summarize:
    type: worker
    topic: job.incident-enricher.summarize
    depends_on: [fetch]
    meta:
      pack_id: incident-enricher
      capability: incident.summarize
      risk_tags: ["network"]
      requires: ["llm"]
    input:
      evidence: ${steps.fetch.output}
    output_schema_id: incident-enricher/Summary

  post:
    type: worker
    topic: job.incident-enricher.post
    depends_on: [summarize]
    meta:
      pack_id: incident-enricher
      capability: incident.post
      risk_tags: ["network", "write"]
      requires: ["slack:webhook"]
    input:
      incident: ${input}
      evidence: ${steps.fetch.output}
      summary: ${steps.summarize.output}
    output_schema_id: incident-enricher/PostResult
